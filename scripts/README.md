# Scripts do ErasmoInvest\n\n## backfill_embeddings.ts\n\n### Descrição\nScript de migração única para re-gerar todos os embeddings existentes usando o novo modelo `gemini-embedding-001` com dimensionalidade 768.\n\n### Pré-requisitos\n1. ✅ Migration `upgrade_embedding_engine` aplicada\n2. ✅ Variável `Gemini-Embedding` configurada no Supabase\n3. ✅ Deno instalado (versão 1.x ou superior)\n\n### Como Executar\n\n```bash\n# Configurar variáveis de ambiente\nexport SUPABASE_URL=\"your-supabase-url\"\nexport SUPABASE_SERVICE_ROLE_KEY=\"your-service-role-key\"\nexport Gemini-Embedding=\"your-gemini-api-key\"\n\n# Executar o script\ncd /path/to/erasmoinvest\ndeno run --allow-net --allow-env scripts/backfill_embeddings.ts\n```\n\n### O que o Script Faz\n\n1. **Validação**: Verifica estrutura do banco e conectividade\n2. **Busca**: Localiza todos os nós existentes na tabela `nodes`\n3. **Processamento**: Re-gera embeddings em lotes de 10 para evitar rate limiting\n4. **Atualização**: Substitui embeddings antigos pelos novos (768d)\n5. **Relatório**: Exibe estatísticas completas do processo\n\n### Características de Segurança\n\n- ✅ **Processamento em lotes** para evitar sobrecarga\n- ✅ **Rate limiting** com pausas entre lotes\n- ✅ **Fallback** para embedding zero em caso de erro\n- ✅ **Logs detalhados** para troubleshooting\n- ✅ **Validação** de entrada e saída\n- ✅ **Estatísticas** de sucesso/falha\n\n### Tempo Estimado\n\n- **100 nós**: ~2-3 minutos\n- **1000 nós**: ~15-20 minutos  \n- **10000 nós**: ~2-3 horas\n\n### Troubleshooting\n\n#### Erro: \"Gemini API error: 429\"\n**Solução**: Rate limiting ativo. O script já tem pausas, mas pode precisar de mais tempo.\n\n#### Erro: \"no rows returned\"\n**Solução**: Normal durante validação. Indica que a função existe mas não há dados.\n\n#### Erro: \"embedding dimension mismatch\"\n**Solução**: Certifique-se de que a migration foi aplicada corretamente.\n\n### Monitoramento\n\nO script exibe progresso em tempo real:\n```\n🚀 Iniciando backfill de embeddings com gemini-embedding-001 (768d)...\n📊 Encontrados 1500 nós para re-processar.\n🔄 Processando lote 1/150 (10 nós)\n✅ 25 nós processados com sucesso\n...\n🎉 Backfill de embeddings concluído!\n📈 Estatísticas:\n   ✅ Nós processados com sucesso: 1485\n   ❌ Nós com erro: 15\n   📊 Total de nós: 1500\n   🎯 Taxa de sucesso: 99.0%\n```\n\n### Após Execução\n\n1. **Teste** a busca híbrida no `cognitive-core`\n2. **Execute** `ingest-news-cron` e `ingest-market-data-cron`\n3. **Monitore** logs de performance via `system-health`\n4. **Valide** melhoria na qualidade dos resultados\n\n---\n\n## ⚠️ IMPORTANTE\n\n**Execute este script apenas UMA vez após a migration.** \n\nEmbeddings futuros serão gerados automaticamente pelos ingestores com a nova dimensionalidade.\n\n**Este script é idempotente** - pode ser executado múltiplas vezes sem causar problemas.