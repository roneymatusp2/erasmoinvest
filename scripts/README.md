# Scripts do ErasmoInvest\n\n## backfill_embeddings.ts\n\n### DescriÃ§Ã£o\nScript de migraÃ§Ã£o Ãºnica para re-gerar todos os embeddings existentes usando o novo modelo `gemini-embedding-001` com dimensionalidade 768.\n\n### PrÃ©-requisitos\n1. âœ… Migration `upgrade_embedding_engine` aplicada\n2. âœ… VariÃ¡vel `Gemini-Embedding` configurada no Supabase\n3. âœ… Deno instalado (versÃ£o 1.x ou superior)\n\n### Como Executar\n\n```bash\n# Configurar variÃ¡veis de ambiente\nexport SUPABASE_URL=\"your-supabase-url\"\nexport SUPABASE_SERVICE_ROLE_KEY=\"your-service-role-key\"\nexport Gemini-Embedding=\"your-gemini-api-key\"\n\n# Executar o script\ncd /path/to/erasmoinvest\ndeno run --allow-net --allow-env scripts/backfill_embeddings.ts\n```\n\n### O que o Script Faz\n\n1. **ValidaÃ§Ã£o**: Verifica estrutura do banco e conectividade\n2. **Busca**: Localiza todos os nÃ³s existentes na tabela `nodes`\n3. **Processamento**: Re-gera embeddings em lotes de 10 para evitar rate limiting\n4. **AtualizaÃ§Ã£o**: Substitui embeddings antigos pelos novos (768d)\n5. **RelatÃ³rio**: Exibe estatÃ­sticas completas do processo\n\n### CaracterÃ­sticas de SeguranÃ§a\n\n- âœ… **Processamento em lotes** para evitar sobrecarga\n- âœ… **Rate limiting** com pausas entre lotes\n- âœ… **Fallback** para embedding zero em caso de erro\n- âœ… **Logs detalhados** para troubleshooting\n- âœ… **ValidaÃ§Ã£o** de entrada e saÃ­da\n- âœ… **EstatÃ­sticas** de sucesso/falha\n\n### Tempo Estimado\n\n- **100 nÃ³s**: ~2-3 minutos\n- **1000 nÃ³s**: ~15-20 minutos  \n- **10000 nÃ³s**: ~2-3 horas\n\n### Troubleshooting\n\n#### Erro: \"Gemini API error: 429\"\n**SoluÃ§Ã£o**: Rate limiting ativo. O script jÃ¡ tem pausas, mas pode precisar de mais tempo.\n\n#### Erro: \"no rows returned\"\n**SoluÃ§Ã£o**: Normal durante validaÃ§Ã£o. Indica que a funÃ§Ã£o existe mas nÃ£o hÃ¡ dados.\n\n#### Erro: \"embedding dimension mismatch\"\n**SoluÃ§Ã£o**: Certifique-se de que a migration foi aplicada corretamente.\n\n### Monitoramento\n\nO script exibe progresso em tempo real:\n```\nğŸš€ Iniciando backfill de embeddings com gemini-embedding-001 (768d)...\nğŸ“Š Encontrados 1500 nÃ³s para re-processar.\nğŸ”„ Processando lote 1/150 (10 nÃ³s)\nâœ… 25 nÃ³s processados com sucesso\n...\nğŸ‰ Backfill de embeddings concluÃ­do!\nğŸ“ˆ EstatÃ­sticas:\n   âœ… NÃ³s processados com sucesso: 1485\n   âŒ NÃ³s com erro: 15\n   ğŸ“Š Total de nÃ³s: 1500\n   ğŸ¯ Taxa de sucesso: 99.0%\n```\n\n### ApÃ³s ExecuÃ§Ã£o\n\n1. **Teste** a busca hÃ­brida no `cognitive-core`\n2. **Execute** `ingest-news-cron` e `ingest-market-data-cron`\n3. **Monitore** logs de performance via `system-health`\n4. **Valide** melhoria na qualidade dos resultados\n\n---\n\n## âš ï¸ IMPORTANTE\n\n**Execute este script apenas UMA vez apÃ³s a migration.** \n\nEmbeddings futuros serÃ£o gerados automaticamente pelos ingestores com a nova dimensionalidade.\n\n**Este script Ã© idempotente** - pode ser executado mÃºltiplas vezes sem causar problemas.