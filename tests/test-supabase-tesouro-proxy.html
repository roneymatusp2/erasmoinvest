<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste da Edge Function - Tesouro Direto Proxy</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #0f172a;
            color: white;
        }
        
        .container {
            background: #1e293b;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        
        button:hover {
            background: #2563eb;
        }
        
        .success {
            color: #10b981;
        }
        
        .error {
            color: #ef4444;
        }
        
        .info {
            color: #06b6d4;
        }
        
        pre {
            background: #0f172a;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .status.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
        }
        
        .status.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
        }
        
        .status.info {
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid #06b6d4;
        }
    </style>
</head>
<body>
    <h1>üèõÔ∏è Teste da Edge Function - Tesouro Direto Proxy</h1>
    
    <div class="container">
        <h2>Status da Implementa√ß√£o</h2>
        <div class="status success">
            ‚úÖ Edge Function "tesouro-direto-proxy" criada no Supabase<br>
            ‚úÖ Fun√ß√£o marketApi.ts atualizada para usar a Edge Function<br>
            ‚úÖ Sistema preparado para resolver problemas de CORS
        </div>
    </div>

    <div class="container">
        <h2>Teste da Edge Function</h2>
        <p>Clique no bot√£o abaixo para testar se a Edge Function est√° funcionando corretamente:</p>
        
        <button onclick="testSupabaseProxy()">üß™ Testar Edge Function</button>
        <button onclick="testDirectAPI()">üîó Testar API Direta (para compara√ß√£o)</button>
        <button onclick="clearResults()">üóëÔ∏è Limpar Resultados</button>
        
        <div id="results"></div>
    </div>

    <div class="container">
        <h2>Teste Espec√≠fico do Investimento</h2>
        <p>Teste com o t√≠tulo espec√≠fico que est√° no banco de dados:</p>
        <input type="text" id="tickerInput" placeholder="TESOURO SELIC 2026" value="TESOURO SELIC 2026" style="padding: 10px; border-radius: 5px; border: 1px solid #374151; background: #374151; color: white; width: 300px;">
        <button onclick="testSpecificTitle()">üéØ Testar T√≠tulo Espec√≠fico</button>
    </div>

    <script>
        const SUPABASE_FUNCTION_URL = 'https://gjvtncdjcslnkfctqnfy.supabase.co/functions/v1/tesouro-direto-proxy';
        const DIRECT_API_URL = 'https://www.tesourodireto.com.br/json/br/com/b3/tesourodireto/service/api/v2/tesouros.json';

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : 'üìù';
            
            div.innerHTML = `<strong>[${timestamp}] ${icon} ${message}</strong>`;
            results.appendChild(div);
            
            // Auto-scroll to bottom
            results.scrollTop = results.scrollHeight;
        }

        function logJSON(data, title = 'Resposta') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.innerHTML = `
                <h3>${title}:</h3>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            results.appendChild(div);
        }

        async function testSupabaseProxy() {
            log('üöÄ Iniciando teste da Edge Function do Supabase...', 'info');
            
            try {
                log('üì° Fazendo requisi√ß√£o para: ' + SUPABASE_FUNCTION_URL, 'info');
                
                const startTime = performance.now();
                const response = await fetch(SUPABASE_FUNCTION_URL);
                const endTime = performance.now();
                
                log(`‚è±Ô∏è Tempo de resposta: ${(endTime - startTime).toFixed(2)}ms`, 'info');
                log(`üìä Status HTTP: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log('‚úÖ Edge Function funcionando corretamente!', 'success');
                log(`üìà Total de t√≠tulos recebidos: ${data.response?.TrsrBdTradgList?.length || 0}`, 'success');
                
                // Mostrar primeiros t√≠tulos
                if (data.response?.TrsrBdTradgList?.length > 0) {
                    const primeiros5 = data.response.TrsrBdTradgList.slice(0, 5).map(t => t.TrsrBd?.nm);
                    log(`üìã Primeiros t√≠tulos: ${primeiros5.join(', ')}`, 'info');
                }
                
                logJSON(data.response?.TrsrBdTradgList?.slice(0, 2) || [], 'Exemplo de 2 t√≠tulos');
                
            } catch (error) {
                log(`‚ùå Erro na Edge Function: ${error.message}`, 'error');
                console.error('Erro completo:', error);
            }
        }

        async function testDirectAPI() {
            log('üîó Testando API direta (pode dar erro de CORS)...', 'info');
            
            try {
                const startTime = performance.now();
                const response = await fetch(DIRECT_API_URL);
                const endTime = performance.now();
                
                log(`‚è±Ô∏è Tempo de resposta: ${(endTime - startTime).toFixed(2)}ms`, 'info');
                log(`üìä Status HTTP: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                const data = await response.json();
                log('‚úÖ API direta funcionou (sem problema de CORS)', 'success');
                log(`üìà Total de t√≠tulos: ${data.response?.TrsrBdTradgList?.length || 0}`, 'success');
                
            } catch (error) {
                log(`‚ùå Erro na API direta (provavelmente CORS): ${error.message}`, 'error');
                log('üí° Isso √© esperado! Por isso criamos a Edge Function.', 'info');
            }
        }

        async function testSpecificTitle() {
            const ticker = document.getElementById('tickerInput').value.trim();
            if (!ticker) {
                log('‚ö†Ô∏è Digite um ticker para testar', 'error');
                return;
            }

            log(`üéØ Testando busca espec√≠fica por: "${ticker}"`, 'info');
            
            try {
                const response = await fetch(SUPABASE_FUNCTION_URL);
                const data = await response.json();
                
                if (!data.response?.TrsrBdTradgList) {
                    throw new Error('Estrutura de resposta inv√°lida');
                }
                
                // Buscar o t√≠tulo espec√≠fico
                const titulo = data.response.TrsrBdTradgList.find(t => 
                    t.TrsrBd?.nm === ticker || 
                    t.TrsrBd?.nm?.includes(ticker) ||
                    ticker.includes(t.TrsrBd?.nm)
                );
                
                if (titulo) {
                    log(`‚úÖ T√≠tulo encontrado: ${titulo.TrsrBd?.nm}`, 'success');
                    log(`üí∞ Valor: R$ ${titulo.TrsrBd?.untrRedVal || titulo.TrsrBd?.minInvstmtAmt}`, 'success');
                    log(`üìÖ Vencimento: ${titulo.TrsrBd?.mtrtyDt || 'N/A'}`, 'info');
                    
                    logJSON(titulo, `Dados completos de "${ticker}"`);
                } else {
                    log(`‚ùå T√≠tulo "${ticker}" n√£o encontrado`, 'error');
                    
                    // Mostrar t√≠tulos similares
                    const similares = data.response.TrsrBdTradgList.filter(t => 
                        t.TrsrBd?.nm?.toLowerCase().includes('selic') ||
                        t.TrsrBd?.nm?.toLowerCase().includes('tesouro')
                    ).slice(0, 5);
                    
                    if (similares.length > 0) {
                        const nomes = similares.map(t => t.TrsrBd?.nm);
                        log(`üí° T√≠tulos similares encontrados: ${nomes.join(', ')}`, 'info');
                    }
                }
                
            } catch (error) {
                log(`‚ùå Erro no teste espec√≠fico: ${error.message}`, 'error');
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            log('üóëÔ∏è Resultados limpos', 'info');
        }

        // Teste autom√°tico ao carregar a p√°gina
        window.onload = function() {
            log('üèõÔ∏è P√°gina de teste carregada', 'info');
            log('üìã Instru√ß√µes:', 'info');
            log('1. Teste a Edge Function para verificar se resolve CORS', 'info');
            log('2. Compare com a API direta (que deve dar erro)', 'info');
            log('3. Teste um t√≠tulo espec√≠fico do seu investimento', 'info');
        };
    </script>
</body>
</html>